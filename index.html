<!DOCTYPE html>
<html>

<head>
    <title>CURSOR-WAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            cursor: none;
        }
    </style>
</head>

<body class="bg-gray-100 m-0 p-0 w-100 h-100" id="board">

    <svg id="cursor" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="fixed">
        <circle cx="0.25" cy="0.25" r="0.25" style="padding: -50px" />
    </svg>

    <!-- <svg id="Gabriel" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
        xmlns="http://www.w3.org/2000/svg">
        <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="white" />
    </svg> -->

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        var users = [];

        var board = document.getElementById("board");
        var cursor = document.getElementById("cursor");
        var username = randomUsername();

        var domElement =
            `<svg id="${username}" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="white" />
        </svg>`;
        board.innerHTML += domElement;
        users.push(username);

        var mouse = document.getElementById(username);

        let color = randomColor();
        cursor.children[0].style.fill = color;
        mouse.style.stroke = color;

        var pointer = {
            x: 0,
            y: 0
        }

        var position = {
            tag: username,
            x: 0,
            y: 0,
            rotation: 0,
            color: color
        };

        var oldPosition = null;

        document.addEventListener("mousemove", function (e) {
            let cursor = document.getElementById("cursor");
            pointer.x = e.pageX;
            pointer.y = e.pageY;

            cursor.style.left = (pointer.x - 5.5) + "px";
            cursor.style.top = (pointer.y - 5.5) + "px";
        });

        function randomColor() {
            var color = Math.floor(Math.random() * 16777215).toString(16);
            return "#" + color;
        }

        function randomUsername() {
            var username = Math.random().toString(36).substring(7);
            return username;
        }

        async function tempo() {
            // wait 1 sec
            await new Promise(resolve => setTimeout(resolve, 10));

            //get difference betwwen position cursor and mouse
            var diffX = position.x - pointer.x;
            var diffY = position.y - pointer.y;

            // calculate deg of rotation of mouse
            var deg = Math.atan2(diffY, diffX) * 180 / Math.PI;


            var moveX = 0;
            if (diffX > 1) {
                moveX = (diffX * 0.05);
                position.x -= moveX;
            }
            else if (diffX < -1) {
                moveX = (diffX * 0.05);
                position.x -= moveX;
            }
            else {
                position.x = pointer.x;
            }

            var moveY = 0;
            if (diffY > 1) {
                moveY = (diffY * 0.05);
                position.y -= moveY;
            }
            else if (diffY < -1) {
                moveY = (diffY * 0.05);
                position.y -= moveY;
            }
            else {
                position.y = pointer.y;
            }

            let mouse = document.getElementById(username);

            mouse.style.left = (position.x - 10) + "px";
            mouse.style.top = (position.y - 12) + "px";

            if (diffX > 5 || diffX < -5 || diffY > 5 || diffY < -5) {
                mouse.style.transform = "rotate(" + (deg - 90) + "deg)";
                position.rotation = deg;
            }

            if (JSON.stringify(position) != JSON.stringify(oldPosition)) {
                socket.emit("move", position);
                oldPosition = Object.assign({}, position);
            }

            tempo();
        }

        tempo();

        socket.on('move', function (data) {
            if (!users.includes(data.tag)) {
                users.push(data.tag);

                var domElement =
                `<svg id="${data.tag}" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="white" />
                </svg>`;

                board.innerHTML += domElement;
            }

            var mouse = document.getElementById(data.tag);
            mouse.style.left = (data.x - 10) + "px";
            mouse.style.top = (data.y - 12) + "px";
            mouse.style.transform = "rotate(" + (data.rotation - 90) + "deg)";
            mouse.style.stroke = data.color;
        });
    </script>
</body>

</html>