<!DOCTYPE html>
<html>

<head>
    <title>CURSOR-WAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #board {
            cursor: none;
        }

        * {
            font-family: 'Roboto', sans-serif;
        }



        .cursor-default {
            cursor: default;
        }
    </style>
</head>

<body class="bg-gray-100 m-0 p-0 w-100 h-100" id="board">

    <div id="hidder" class="fixed bg-neutral-900 top-0 opacity-50 w-full h-full z-10 cursor-default"
        style="transition: 1s; left: 0px;"></div>
    <div id="menu" class="fixed  top-0  w-full h-full z-10 cursor-default" style="transition: 1s; left: 0px;">
        <div class="flex flex-col justify-center items-center h-full cursor-default">
            <h1 class="text-6xl text-white pb-16 cursor-default">CURSOR-WAR</h1>
            <input type="text" id="username" class="bg-white rounded-lg p-2 mb-6 placeholder:text-black cursor-default"
                placeholder="Enter your username" maxlength="14">

            <!-- color picker -->
            <div class="flex flex-row justify-center items-center cursor-default pb-4">
                <div class="flex flex-col justify-center items-center cursor-default">
                    <h1 class="text-white text-2xl cursor-default">Choose your color</h1>
                    <div class="flex flex-row justify-center items-center cursor-default">
                        <button class="bg-red-500 w-10 h-10 rounded-full m-2 cursor-default color-picker"
                            onclick="changeColor('#ef4444')" id="ef4444"></button>
                        <button class="bg-blue-500 w-10 h-10 rounded-full m-2 cursor-default color-picker"
                            onclick="changeColor('#3b82f6')" id="3b82f6"></button>
                        <button class="bg-green-500 w-10 h-10 rounded-full m-2 cursor-default color-picker"
                            onclick="changeColor('#22c55e')" id="22c55e"></button>
                        <button class="bg-orange-500 w-10 h-10 rounded-full m-2 cursor-default color-picker"
                            onclick="changeColor('#f97316')" id="f97316"></button>
                    </div>
                </div>
            </div>
            <button class="bg-white text-black text-2xl px-4 py-2 rounded-lg mt-4" onclick="login()">START</button>
        </div>
    </div>

    <div class="fixed bottom-10 right-10 rounded-full h-16 w-16 bg-indigo-400 z-10 cursor-pointer">
        <button onclick="openTchat()" class="flex w-full h-full cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-8 h-8 m-auto text-white cursor-pointer">
                <path stroke-linecap="round" stroke-linejoin="round" class="cursor-pointer"
                    d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
            </svg>
        </button>
    </div>

    <div id="tchat" class="fixed top-0 bg-indigo-400 h-full z-10 cursor-default" style="width: 500px; right: -500px;">
        <div class="flex h-1/4">
            <button class="px-4" onclick="closeTchat()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-10 h-10 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            <h1 class="w-full text-center m-auto text-xl font-semibold uppercase text-white">Tchat CURSOR-WAR</h1>
        </div>
        <div id="chat" class="flex flex-col w-full h-2/4 px-6" style="overflow: auto;">
            <!-- <div class="flex flex-col bg-indigo-100 w-3/4 py-2 my-2 rounded">
                <p class="px-2 font-semibold pb-2">Username</p>
                <p class="px-2">Message</p>
            </div>

            <div class="flex flex-col bg-indigo-100 w-3/4 py-2 my-2 ml-auto rounded">
                <p class="px-2 font-semibold pb-2">Username</p>
                <p class="px-2">Message</p>
            </div>

            <div class="flex flex-col bg-indigo-100 w-3/4 py-2 my-2 ml-auto rounded">
                <p class="px-2 font-semibold pb-2">Username</p>
                <p class="px-2">Message</p>
            </div>

            <div class="flex flex-col bg-indigo-100 w-3/4 py-2 my-2 ml-auto rounded">
                <p class="px-2 font-semibold pb-2">Username</p>
                <p class="px-2">Message</p>
            </div>

            <div class="flex flex-col bg-indigo-100 w-3/4 py-2 my-2 ml-auto rounded">
                <p class="px-2 font-semibold pb-2">Username</p>
                <p class="px-2">Message</p>
            </div>

            <div class="flex flex-col bg-indigo-100 w-3/4 py-2 my-2 ml-auto rounded">
                <p class="px-2 font-semibold pb-2">Username</p>
                <p class="px-2">Message</p>
            </div>

            <div class="flex flex-col bg-indigo-100 w-3/4 py-2 my-2 ml-auto rounded">
                <p class="px-2 font-semibold pb-2">Username</p>
                <p class="px-2">Message</p>
            </div> -->
        </div>
        <div class="flex px-6 py-6">
            <input type="text" name="message" id="message" class="bg-white rounded w-2/3 py-3 px-2"
                placeholder="Message ...">
            <button class="w-1/3 bg-indigo-600 ml-2 rounded text-white" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- <svg id="cursor" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="fixed">
        <circle cx="0.25" cy="0.25" r="0.25" style="padding: -50px" />
    </svg> -->

    <!-- <svg id="Gabriel" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
        xmlns="http://www.w3.org/2000/svg">
        <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="white" />
    </svg> -->

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        var board = document.getElementById("board");
        var users = [];

        var username;
        var color = randomColor();
        let DOMElement = document.getElementById(color.substring(1));
        DOMElement.style.border = "2px solid white";

        var pointer = {
            x: 0,
            y: 0
        };

        var position = {
            x: 0,
            y: 0,
            rotation: 0,
        };
        var oldPosition = null;

        function randomColor() {
            var colors = ["#ef4444", "#3b82f6", "#22c55e", "#f97316"];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function changeColor(choosen) {
            //remove border for each element with class color-picker
            var colorPickers = document.getElementsByClassName("color-picker");
            for (var i = 0; i < colorPickers.length; i++) {
                colorPickers[i].style.border = "none";
            }

            //add border to choosen color
            let DOMElement = document.getElementById(choosen.substring(1));
            DOMElement.style.border = "2px solid white";

            color = choosen;
        }

        function openTchat() {
            document.getElementById("tchat").style.right = "0px";
        }

        function closeTchat() {
            document.getElementById("tchat").style.right = "-500px";
        }

        function sendMessage() {
            if (document.getElementById("message").value != "" && username != undefined) {
                var message = document.getElementById("message").value;
                socket.emit("message", {
                    username: username,
                    message: message
                });

                var chat = document.getElementById("chat");
                var div = document.createElement("div");
                div.classList.add("flex", "flex-col", "bg-indigo-100", "w-3/4", "py-2", "my-2", "ml-auto", "rounded");

                var p1 = document.createElement("p");
                p1.classList.add("px-2", "font-semibold", "pb-2");
                p1.innerHTML = username;

                var p2 = document.createElement("p");
                p2.classList.add("px-2");
                p2.innerHTML = message;

                div.appendChild(p1);
                div.appendChild(p2);

                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;

                document.getElementById("message").value = "";
            }
            else{
                alert("Please enter a username and a message.");
            }
        }

        // function randomUsername() {
        //     var username = Math.random().toString(36).substring(7);
        //     return username;
        // }

        async function tempo() {
            // wait 1 sec
            await new Promise(resolve => setTimeout(resolve, 10));

            //get difference betwwen position cursor and mouse
            var diffX = position.x - pointer.x;
            var diffY = position.y - pointer.y;

            // calculate deg of rotation of mouse
            var deg = Math.atan2(diffY, diffX) * 180 / Math.PI;

            var moveX = 0;
            if (diffX > 1) {
                moveX = (diffX * 0.05);
                position.x -= moveX;
            }
            else if (diffX < -1) {
                moveX = (diffX * 0.05);
                position.x -= moveX;
            }
            else {
                position.x = pointer.x;
            }

            var moveY = 0;
            if (diffY > 1) {
                moveY = (diffY * 0.05);
                position.y -= moveY;
            }
            else if (diffY < -1) {
                moveY = (diffY * 0.05);
                position.y -= moveY;
            }
            else {
                position.y = pointer.y;
            }

            let mouse = document.getElementById(username);
            mouse.style.left = (position.x - 10) + "px";
            mouse.style.top = (position.y - 12) + "px";

            // username text width
            let username_text = document.getElementById("username_" + username);
            var username_text_width = username_text.clientWidth;

            //center username text under mouse
            username_text.style.left = (position.x - (username_text_width / 2)) + "px";
            username_text.style.top = (position.y + 10) + "px";

            if (diffX > 5 || diffX < -5 || diffY > 5 || diffY < -5) {
                mouse.style.transform = "rotate(" + (deg - 90) + "deg)";
                position.rotation = deg;
            }

            if (JSON.stringify(position) != JSON.stringify(oldPosition)) {
                socket.emit("move", position);
                oldPosition = Object.assign({}, position);
            }

            tempo();
        }

        function login() {
            let username = document.getElementById("username").value;

            if (username == "") {
                alert("Please enter a username");
                return;
            }

            socket.emit('login', {
                username: document.getElementById("username").value,
                color: color
            });
        }

        function startGame() {
            username = document.getElementById("username").value;

            var menu = document.getElementById("menu");
            var hidder = document.getElementById("hidder");
            menu.style.left = "-100%";
            hidder.style.left = "-100%";

            // create cursor for user
            let DOMCursor =
                `<svg id="cursor" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="fixed">
                <circle cx="0.25" cy="0.25" r="0.25" style="padding: -50px" />
            </svg>`;
            board.innerHTML += DOMCursor;
            var cursor = document.getElementById("cursor");

            // create mouse for user
            var domElement =
                `<svg id="${username}" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="${color}"/>
            </svg>
            <text id="username_${username}" class="fixed">${username}</text>`;
            board.innerHTML += domElement;
            var mouse = document.getElementById(username);
            mouse.style.stroke = "black";

            // add cursor pointer movement event
            document.addEventListener("mousemove", function (e) {
                let cursor = document.getElementById("cursor");
                pointer.x = e.pageX;
                pointer.y = e.pageY;

                cursor.style.left = (pointer.x - 5.5) + "px";
                cursor.style.top = (pointer.y - 5.5) + "px";
            });

            // prepare initial position of mouse and color historisation
            // position.username = username;
            // position.color = color;

            tempo();
        }

        // SOCKET IO SECTION

        socket.on('login', function (response) {
            if (response.success) {
                startGame();
            }
            else {
                alert(response.message);
            }
        });

        socket.on('move', function (data) {
            let found = users.find(element => element.username == data.username);

            if (!found) {
                users.push({ username: data.username, socket_id: data.socket_id });

                var domElement =
                    `<svg id="${data.username}" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="${data.color}"/>
                </svg>
                <text id="username_${data.username}" class="fixed">${data.username}</text>`;
                board.innerHTML += domElement;

                let mouse = document.getElementById(data.username);
                mouse.style.stroke = "black";
            }

            let mouse = document.getElementById(data.username);
            mouse.style.left = (data.x - 10) + "px";
            mouse.style.top = (data.y - 12) + "px";
            mouse.style.transform = "rotate(" + (data.rotation - 90) + "deg)";

            // username text width
            let username_text = document.getElementById("username_" + data.username);
            var username_text_width = username_text.clientWidth;

            //center username text under mouse
            username_text.style.left = (data.x - (username_text_width / 2)) + "px";
            username_text.style.top = (data.y + 10) + "px";
        });

        socket.on('remove', function (socket_id) {
            var data = users.find(function (user) {
                return user.socket_id == socket_id;
            });

            if (data) {
                let mouse = document.getElementById(data.username);
                let username_text = document.getElementById("username_" + data.username);
                mouse.remove();
                username_text.remove();
            }
        });

        socket.on('message', function (data) {
            console.log(data);
            let message = document.createElement("div");
            message.classList.add("flex", "flex-col", "bg-indigo-100", "w-3/4", "py-2", "my-2", "rounded");

            let username = document.createElement("p");
            username.classList.add("px-2", "font-semibold", "pb-2");
            username.innerHTML = data.username;

            let text = document.createElement("p");
            text.classList.add("px-2");
            text.innerHTML = data.message;

            message.appendChild(username);
            message.appendChild(text);

            let chat = document.getElementById("chat");
            chat.appendChild(message);

            chat.scrollTop = chat.scrollHeight;
        });
    </script>
</body>

</html>