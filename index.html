<!DOCTYPE html>
<html>

<head>
    <title>CURSOR-WAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            cursor: none;
        }

        .cursor-menu {
            cursor: default;
        }
    </style>
</head>

<body class="bg-gray-100 m-0 p-0 w-100 h-100" id="board">

    <div id="menu" class="fixed bg-neutral-900 top-0 opacity-50 w-full h-full z-10 cursor-menu"
        style="transition: 1s; left: 0px;">
        <div class="flex flex-col justify-center items-center h-full cursor-menu">
            <h1 class="text-6xl text-white py-6 cursor-menu">CURSOR-WAR</h1>
            <input type="text" id="username" class="bg-white rounded-lg p-2 m-2 placeholder:text-black cursor-menu"
                placeholder="Enter your username">
            <button class="bg-white text-black text-2xl px-4 py-2 rounded-lg mt-4" onclick="startGame()">START</button>
        </div>
    </div>

    <!-- <svg id="cursor" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="fixed">
        <circle cx="0.25" cy="0.25" r="0.25" style="padding: -50px" />
    </svg> -->

    <!-- <svg id="Gabriel" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
        xmlns="http://www.w3.org/2000/svg">
        <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="white" />
    </svg> -->

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        var board = document.getElementById("board");
        var users = [];

        var username;

        var pointer = {
            x: 0,
            y: 0
        };

        var position = {
            x: 0,
            y: 0,
            rotation: 0,
        };
        var oldPosition = null;

        function randomColor() {
            var color = Math.floor(Math.random() * 16777215).toString(16);
            return "#" + color;
        }

        function randomUsername() {
            var username = Math.random().toString(36).substring(7);
            return username;
        }

        async function tempo() {
            // wait 1 sec
            await new Promise(resolve => setTimeout(resolve, 10));

            //get difference betwwen position cursor and mouse
            var diffX = position.x - pointer.x;
            var diffY = position.y - pointer.y;

            // calculate deg of rotation of mouse
            var deg = Math.atan2(diffY, diffX) * 180 / Math.PI;


            var moveX = 0;
            if (diffX > 1) {
                moveX = (diffX * 0.05);
                position.x -= moveX;
            }
            else if (diffX < -1) {
                moveX = (diffX * 0.05);
                position.x -= moveX;
            }
            else {
                position.x = pointer.x;
            }

            var moveY = 0;
            if (diffY > 1) {
                moveY = (diffY * 0.05);
                position.y -= moveY;
            }
            else if (diffY < -1) {
                moveY = (diffY * 0.05);
                position.y -= moveY;
            }
            else {
                position.y = pointer.y;
            }

            let mouse = document.getElementById(username);
            let tag_username = document.getElementById("tag_" + username);

            mouse.style.left = (position.x - 10) + "px";
            mouse.style.top = (position.y - 12) + "px";

            tag_username.style.left = (position.x - 25) + "px";
            tag_username.style.top = (position.y + 10) + "px";

            if (diffX > 5 || diffX < -5 || diffY > 5 || diffY < -5) {
                mouse.style.transform = "rotate(" + (deg - 90) + "deg)";
                position.rotation = deg;
            }

            if (JSON.stringify(position) != JSON.stringify(oldPosition)) {
                socket.emit("move", position);
                oldPosition = Object.assign({}, position);
            }

            tempo();
        }

        function startGame() {
            username = document.getElementById("username").value;
            var menu = document.getElementById("menu");
            menu.style.left = "-100%";

            // create cursor for user
            let DOMCursor =
                `<svg id="cursor" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" class="fixed">
                <circle cx="0.25" cy="0.25" r="0.25" style="padding: -50px" />
            </svg>`;
            board.innerHTML += DOMCursor;
            var cursor = document.getElementById("cursor");

            // create mouse for user
            var domElement =
                `<svg id="${username}" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="white" />
            </svg>
            <text id="tag_${username}" class="fixed">${username}</text>`;
            board.innerHTML += domElement;
            var mouse = document.getElementById(username);

            // add custom cursor style
            let color = randomColor();
            cursor.children[0].style.fill = color;
            mouse.style.stroke = color;

            // add cursor pointer movement event
            document.addEventListener("mousemove", function (e) {
                let cursor = document.getElementById("cursor");
                pointer.x = e.pageX;
                pointer.y = e.pageY;

                cursor.style.left = (pointer.x - 5.5) + "px";
                cursor.style.top = (pointer.y - 5.5) + "px";
            });

            // prepare initial position of mouse and color historisation
            position.username = username;
            position.color = color;

            tempo();
        }

        // SOCKET IO SECTION

        socket.on('move', function (data) {
            let found = users.find(element => element.tag == data.tag);

            if (!found) {
                users.push({ tag: data.tag, socket_id: data.socket_id });

                var domElement =
                    `<svg id="${data.tag}" class="fixed" width="17" height="21" viewBox="0 0 17 21" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.49995 0L16.7272 20.25L8.49995 17.5L0.272705 20.25L8.49995 0Z" fill="white" />
                </svg>
                <text id="tag_${data.tag}" class="fixed">${data.tag}</text>`;

                board.innerHTML += domElement;
            }

            let mouse = document.getElementById(data.tag);
            mouse.style.left = (data.x - 10) + "px";
            mouse.style.top = (data.y - 12) + "px";
            mouse.style.transform = "rotate(" + (data.rotation - 90) + "deg)";
            mouse.style.stroke = data.color;

            let tag_username = document.getElementById("tag_" + data.tag);
            tag_username.style.left = (data.x - 25) + "px";
            tag_username.style.top = (data.y + 10) + "px";
        });

        socket.on('remove', function (socket_id) {
            var data = users.find(function (user) {
                return user.socket_id == socket_id;
            });

            if (data) {
                let mouse = document.getElementById(data.tag);
                mouse.remove();
                let tag_username = document.getElementById("tag_" + data.tag);
                tag_username.remove();
            }
        });
    </script>
</body>

</html>